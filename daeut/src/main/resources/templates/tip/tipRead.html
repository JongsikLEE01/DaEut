<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/layout/tip_layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>Da E ut</title>
</head>
<body layout:fragment="content">

    <div class="container">
        <form id="form" th:action="@{/tip/tipDelete}" method="post" enctype="multipart/form-data">
            <input type="hidden" name="boardNo" th:value="${board.boardNo}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <div class="main">
            <h2 class="mt-4" th:text="${board.boardTitle}">게시글 제목</h2>
            <div class="d-flex justify-content-between align-items-center mt-2">
                <input type="text" id="userId" th:value="${board.userNo}" placeholder="userId" disabled>
                
                <div class="d-flex gap-2">
                    <a th:href="@{/tip/index}" class="boardList">목록</a>
                    <a th:href="@{/tip/tipUpdate(no=${board.boardNo})}" class="boardUpdate">수정</a>
                </div>
            </div>
            <hr>
     
           <div class="text-center my-4">
                <!-- ⭐ 파일 이미지 출력하기 -->
                <th:block th:each="file : ${fileList}"> 
                    <img th:src="|/file/img/${file.fileNo}|" alt="모기 퇴치 방법" class="img-fluid">
                </th:block>
            </div> 
            <div class="col-15">
                <textarea class="form-control w-100 input-readonly" rows="15" readonly th:text="${board.boardContent}">게시글 내용</textarea>
            </div>

            <hr class="separator">

            <!-- 댓글 섹션 -->
            <!-- 댓글 입력 -->
            <div id="reply-input">
                <h3>댓글</h3>
                <div class="input-group mt-1 mb-3 reply-input">
                    <textarea name="replyContent" id="reply-content" class="form-control" placeholder="댓글을 입력하세요." rows="1"></textarea>
                    <button class="btn btn-primary" type="button" id="btn-reply-insert" onclick="insertReply()">등록</button>
                </div>
            </div>

            <!-- 댓글 목록 -->
            <div id="reply-list">
                <div th:each="reply : ${replies}" class="comment">
                    <p><strong th:text="${reply.userNo}">아이디</strong></p>
                    <p th:text="${reply.replyContent}">댓글 내용</p>
                    <div class="comment-actions">
                        <span th:text="${#dates.format(reply.replyRegDate, 'yyyy-MM-dd')}">2023-05-22</span>
                        <button>답글달기</button>
                        <button>수정</button>
                        <button>삭제</button>
                    </div>
                    <div th:each="response : ${reply.responses}" class="comment-response">
                        <p><strong th:text="${response.userNo}">운영자</strong></p>
                        <p th:text="${response.replyContent}">답변 내용</p>
                        <div class="comment-actions">
                            <span th:text="${#dates.format(response.replyRegDate, 'yyyy-MM-dd')}">2023-05-22</span>
                            <button>수정</button>
                            <button>삭제</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        let no = "[[${board.boardNo}]]"
        let userNo = "[[${session.user.userNo}]]"
        var csrfToken = "[[${_csrf.token}]]"

        replyList()

        // 수정 화면 이동
        function moveUpdate() {
            location.href = '/tip/tipUpdate?no=' + no
        }
    
        // 삭제 요청
        function actionDelete() {
            let check = confirm('정말로 삭제하시겠습니까?')
            if( check ) {
                form.action = '/tip/tipDelete'
                form.submit()
            }
        }

        // 목록 화면 이동
        function moveList() {
            location.href = '/tip/index'
        }

        // 파일 삭제
        function deleteFile(element, no) {
            // alert(no)
            
            // AJAX 비동기 요청
            let request = new XMLHttpRequest()

            // 요청 세팅
            // request.open(요청메소드, URL)
            request.open('DELETE', '/file/img/' + no)
            request.send()

            request.onreadystatechange = function() {

                // 요청 성공 시,
                if( request.readyState == request.DONE && request.status == 200 ) {
                    console.log('파일 삭제 성공!');
                    // 파일 항목 제거
                    element.parentNode.remove()
                }
            }
        }

        // 댓글 목록
        function replyList() {
            let request = new XMLHttpRequest()

            request.open('GET', '/tip/' + no)
            request.send()

            request.onreadystatechange = function() {
                if( request.readyState == request.DONE && request.status == 200 ) {
                    let response = request.responseText

                    let data = response

                    let replyList = document.getElementById('reply-list')
                    replyList.innerHTML = data

                    event()
                }
            }
        }
            
        // 댓글 등록
        function insertReply() {
            // let $wuserNo = document.getElementById('reply-writer')
            let $content = document.getElementById('reply-content')
            let replyContent = $content.value

            console.log(`글번호 : ${no}`)
            console.log(`댓글 내용 : ${replyContent}`)
            console.log(`회원번호 : ${userNo}`)     // 이거 없으면 로그인

            let data = {
                'boardNo' : no,
                'userNo'  : userNo,
                'replyContent' : replyContent
            }

            let request = new XMLHttpRequest()
            
            request.open('POST', '/reply/insert')
            request.setRequestHeader("X-CSRF-TOKEN", csrfToken) 
            request.setRequestHeader('Content-Type', 'application/json')

            alert(JSON.stringify(data)  )
            request.send( JSON.stringify(data) )

            request.onreadystatechange = function() {
                // 요청 성공 시,
                if( request.readyState == request.DONE && request.status == 200 ) {
                    console.log('댓글 등록 성공!');
                    // alert(request.responseText)     // 응답 메시지 확인
                    let response = request.responseText
                    if( response == 'SUCCESS' ){
                        alert("댓글 등록 성공!!!")
                        replyList()     // 댓글 목록 갱신
                        // 댓글 입력 창 비우기
                        $content.value = ''
                    }
                }
            }
        }
        </script>

</body>
</html>
