<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/layout/tip_layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>Da E ut</title>
</head>
<body layout:fragment="content">

    <div class="container">
        <form id="form" th:action="@{/tip/tipDelete}" method="post" enctype="multipart/form-data">
            <input type="hidden" name="boardNo" th:value="${board.boardNo}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div class="main">
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <h2 th:text="${board.boardTitle}">게시글 제목</h2>
                    <span th:text="${#dates.format(board.boardRegDate, 'yyyy-MM-dd HH:mm')}" style="font-size: 0.8em;">등록 날짜: 2023-05-22 10:00</span>
                </div>
                <!-- <h2 class="mt-4" th:text="${board.boardTitle}">게시글 제목</h2> -->
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <div class="d-flex flex-column gap-2">
                        
                        <!-- <span><i class="fa fa-eye"></i> <span th:text="${board.boardViews}">0</span></span>
                        <span th:text="'좋아요: ' + ${board.boardLike}" id="like-count">좋아요: 0</span> -->
                        <!-- <span th:text="${#dates.format(board.boardRegDate, 'yyyy-MM-dd HH:mm')}">등록 날짜: 2023-05-22 10:00</span> -->
                    </div>     
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <input type="text" id="userId" th:value="${board.userId}" placeholder="userId" disabled>
                    <div class="d-flex gap-2" style="font-size: 0.8em;">
                        <span><i class="fa-regular fa-eye"></i> <span th:text="${board.boardViews}">0</span></span>
                        <!-- <span><i class="fa fa-comments"></i> <span th:text="${board.reply}">0</span></span> -->
                        <span th:text="'추천수: ' + ${board.boardLike}" id="like-count">좋아요: 0</span>
                    </div>
                </div>
                <!-- <div class="d-flex justify-content-between align-items-center mt-2">
                    <span><i class="fa fa-thumbs-up"></i> <span th:text="${board.boardLike}" id="like-count">0</span></span>
                    <button id="like-button" class="heart-button2" type="button" data-board-no="${board.boardNo}">
                        <i class="fa fa-heart" aria-hidden="true"></i>
                    </button>
                </div> -->
                <hr class="my-2">
                <div class="text-center my-5">
                    <!-- ⭐ 파일 이미지 출력하기 -->
                    <th:block th:each="file : ${fileList}"> 
                        <img th:src="|/file/img/${file.fileNo}|" alt="파일 이미지" class="img-fluid" style="width: 300px; height: 300px;">
                    </th:block>
                </div>
                <div class="col-15">
                    <div class="w-100 input-readonly" style="white-space: pre-wrap;" th:text="${board.boardContent}"></div>
                </div>
                <div class="d-flex justify-content-center align-items-center" style="margin-top: 6rem;">
                    <div class="like-button-wrapper like-button" id="like-button" data-board-no="${board.boardNo}">
                        <i class="fa-solid fa-thumbs-up" aria-hidden="true"></i>
                        <span>추천</span>
                    </div>
                </div>
                <hr class="separator">
            </form>
            <div class="d-flex justify-content-end gap-2 mt-2">
                <a th:href="@{/tip/index}" class="boardList">목록</a>
                <a th:if="${isWriter}" th:href="@{/tip/tipUpdate(no=${board.boardNo})}" class="boardUpdate">수정</a>
                <button th:if="${isWriter}" th:onclick="actionDelete()" class="boardDelete">삭제</button>
            </div>

            <!-- 댓글 섹션 -->
            <!-- 댓글 입력 -->
            <div id="reply-input">
                <h3>댓글</h3>
                <div class="input-group mt-1 mb-3 reply-input">
                    <form action="/reply/insert" method="post">
                        <input type="hidden" name="boardNo" th:value="${board.boardNo}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <input type="hidden" th:name="userNo" th:value="${session.user.userNo}">
                        <!-- <textarea name="replyContent" id="reply-content" class="form-control" placeholder="댓글을 입력하세요." rows="1"></textarea> -->
                        <input type="text" name="replyContent" id="reply-content" class="form-control" placeholder="댓글을 입력하세요."></input>
                        <!-- <button class="btn btn-primary" type="submit" id="btn-reply-insert" onclick="insertReply()">등록</button> -->
                        <input class="btn btn-primary" type="submit" id="btn-reply-insert">등록</input>
                    </form>
                </div>
            </div>

            <!-- 댓글 목록 -->
            <div id="reply-list">
                <div th:each="reply : ${replies}" class="comment">
                    <p><strong th:text="${reply.userNo}">아이디</strong></p>
                    <p th:text="${reply.replyContent}">댓글 내용</p>
                    <div class="comment-actions">
                        <span th:text="${#dates.format(reply.replyRegDate, 'yyyy-MM-dd')}">2023-05-22</span>
                        <button>답글달기</button>
                        <button>수정</button>
                        <button>삭제</button>
                    </div>
                    <div th:each="response : ${reply.responses}" class="comment-response">
                        <p><strong th:text="${response.userNo}">운영자</strong></p>
                        <p th:text="${response.replyContent}">답변 내용</p>
                        <div class="comment-actions">
                            <span th:text="${#dates.format(response.replyRegDate, 'yyyy-MM-dd')}">2023-05-22</span>
                            <button>수정</button>
                            <button>삭제</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById("like-button").addEventListener("click", function() {
            const boardNo = document.querySelector('input[name="boardNo"]').value;
            const userNo = document.querySelector('input[name="userNo"]').value; // 사용자 번호 가져오기
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch(`/tip/${boardNo}/like?userNo=${userNo}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let likeCountElement = document.getElementById("like-count");
                    let likeCount = parseInt(likeCountElement.textContent.split(": ")[1]) + 1;
                    likeCountElement.textContent = `추천수: ${likeCount}`;
                    alert(data.message); // 추천 완료 메시지 표시
                } else {
                    alert(data.message); // 이미 추천했습니다 메시지 표시
                }
            })
            .catch(error => console.error('Error:', error));
        });

        document.addEventListener('DOMContentLoaded', () => {
            const heartButtons = document.querySelectorAll('.heart-button, .heart-button2');
            heartButtons.forEach(button => {
                button.addEventListener('click', () => {
                    button.classList.toggle('active');
                });
            });
        });

        let no = "[[${board.boardNo}]]"
        let userNo = "[[${session.user.userNo}]]"
        var csrfToken = "[[${_csrf.token}]]"
        const csrfHeader = document.querySelector("meta[name='_csrf_header']").content;

        replyList()

        // 수정 화면 이동
        function moveUpdate() {
            location.href = '/tip/tipUpdate?no=' + no
        }
    
        // 삭제 요청
        function actionDelete() {
            let check = confirm('정말로 삭제하시겠습니까?')
            if( check ) {
                form.action = '/tip/tipDelete'
                form.submit()
            }
        }

        // 목록 화면 이동
        function moveList() {
            location.href = '/tip/index'
        }

        // 댓글 목록
        function replyList() {
            let request = new XMLHttpRequest()

            request.open('GET', '/tip/' + no)
            request.send()

            request.onreadystatechange = function() {
                if( request.readyState == request.DONE && request.status == 200 ) {
                    let response = request.responseText

                    let data = response

                    let replyList = document.getElementById('reply-list')
                    replyList.innerHTML = data

                    event()
                }
            }
        }

        // document.getElementById('like-button').addEventListener('click', function(event) {
        //     event.preventDefault();

        //     fetch('/board/like', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json',
        //             [csrfHeader]: csrfToken
        //         },
        //         body: JSON.stringify({
        //             boardNo: no
        //         })
        //     })
        //     .then(response => response.json())
        //     .then(data => {
        //         if (data.success) {
        //             document.querySelector("span[th\\:text*='좋아요']").textContent = `좋아요: ${data.likeCount}`;
        //         } else {
        //             alert('좋아요 처리 중 오류가 발생했습니다.');
        //         }
        //     })
        //     .catch(error => {
        //         console.error('Error:', error);
        //     });
        // });
            
        // 댓글 등록
        // function insertReply() {
        //     // let $wuserNo = document.getElementById('reply-writer')
        //     let $content = document.getElementById('reply-content')
        //     let replyContent = $content.value
            
        //     console.log(`글번호 : ${no}`)
        //     console.log(`댓글 내용 : ${replyContent}`)
        //     console.log(`회원번호 : ${userNo}`)     // 이거 없으면 로그인

        //     let data = {
        //         'boardNo' : no,
        //         'userNo'  : replyContent,
        //         'replyContent' : userNo
        //     }

        //     let request = new XMLHttpRequest()
        //     request.open('POST', '/reply/insert')
        //     request.setRequestHeader(csrfHeader, csrfToken) 
        //     request.setRequestHeader('Content-Type', 'application/json')

        //     alert(JSON.stringify(data)  )
        //     request.send( JSON.stringify(data) )

        //     request.onreadystatechange = function() {
        //         // 요청 성공 시,
        //         if( request.readyState == request.DONE && request.status == 201 ) {
        //             console.log('댓글 등록 성공!');
        //             // alert(request.responseText)     // 응답 메시지 확인
        //             let response = request.responseText
        //             if( response == 'SUCCESS' ){
        //                 alert("댓글 등록 성공!!!")
        //                 replyList()     // 댓글 목록 갱신
        //                 // 댓글 입력 창 비우기
        //                 $content.value = ''
        //             }
        //         }
        //     }
        // }
        </script>

</body>
</html>
